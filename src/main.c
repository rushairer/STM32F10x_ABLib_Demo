#include "stm32f10x.h"
#include "stm32f10x_abl_delay.h"
#include "stm32f10x_abl_led.h"
#include "stm32f10x_abl_key.h"
#include "stm32f10x_abl_oled.h"
#include "stm32f10x_abl_servo.h"
#include "stm32f10x_abl_pca9685.h"
#include "stm32f10x_abl_key4x4.h"

const uint8_t OLED_BMP1[] =
    {
        0x00, 0x03, 0x05, 0x09, 0x11, 0xFF, 0x11, 0x89, 0x05, 0xC3, 0x00, 0xE0, 0x00, 0xF0, 0x00, 0xF8,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x28, 0xFF, 0x11, 0xAA, 0x44, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0x01, 0x38, 0x44, 0x82, 0x92,
        0x92, 0x74, 0x01, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x44, 0xFF, 0x01, 0x7D,
        0x7D, 0x7D, 0x01, 0x7D, 0x7D, 0x7D, 0x7D, 0x01, 0x7D, 0x7D, 0x7D, 0x7D, 0x7D, 0x01, 0xFF, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01,
        0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x03, 0x03,
        0xF3, 0x13, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x01, 0xF1, 0x11, 0x61, 0x81, 0x01, 0x01, 0x01,
        0x81, 0x61, 0x11, 0xF1, 0x01, 0x01, 0x01, 0x01, 0x41, 0x41, 0xF1, 0x01, 0x01, 0x01, 0x01, 0x01,
        0xC1, 0x21, 0x11, 0x11, 0x11, 0x11, 0x21, 0xC1, 0x01, 0x01, 0x01, 0x01, 0x41, 0x41, 0xF1, 0x01,
        0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0xD3, 0x33,
        0x03, 0x03, 0x3F, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0x00, 0x00,
        0x7F, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x7F, 0x00, 0x00, 0x01, 0x06, 0x18, 0x06,
        0x01, 0x00, 0x00, 0x7F, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x7F, 0x40, 0x40, 0x00, 0x00, 0x00,
        0x1F, 0x20, 0x40, 0x40, 0x40, 0x40, 0x20, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x7F, 0x40,
        0x40, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x40, 0x30, 0x0C, 0x03, 0x00, 0x00,
        0x00, 0x00, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x06, 0x06,
        0x06, 0x06, 0x04, 0x04, 0x04, 0x84, 0x44, 0x44, 0x44, 0x84, 0x04, 0x04, 0x84, 0x44, 0x44, 0x44,
        0x84, 0x04, 0x04, 0x04, 0x84, 0xC4, 0x04, 0x04, 0x04, 0x04, 0x84, 0x44, 0x44, 0x44, 0x84, 0x04,
        0x04, 0x04, 0x04, 0x04, 0x84, 0x44, 0x44, 0x44, 0x84, 0x04, 0x04, 0x04, 0x04, 0x04, 0x84, 0x44,
        0x44, 0x44, 0x84, 0x04, 0x04, 0x84, 0x44, 0x44, 0x44, 0x84, 0x04, 0x04, 0x04, 0x04, 0x06, 0x06,
        0x06, 0x06, 0x07, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x18, 0x14, 0x12, 0x11, 0x00, 0x00, 0x0F, 0x10, 0x10, 0x10,
        0x0F, 0x00, 0x00, 0x00, 0x10, 0x1F, 0x10, 0x00, 0x00, 0x00, 0x08, 0x10, 0x12, 0x12, 0x0D, 0x00,
        0x00, 0x18, 0x00, 0x00, 0x0D, 0x12, 0x12, 0x12, 0x0D, 0x00, 0x00, 0x18, 0x00, 0x00, 0x10, 0x18,
        0x14, 0x12, 0x11, 0x00, 0x00, 0x10, 0x18, 0x14, 0x12, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80,
        0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x7F, 0x03, 0x0C, 0x30, 0x0C, 0x03, 0x7F, 0x00, 0x00, 0x38, 0x54, 0x54, 0x58, 0x00, 0x00,
        0x7C, 0x04, 0x04, 0x78, 0x00, 0x00, 0x3C, 0x40, 0x40, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xAA, 0xAA, 0xAA,
        0x28, 0x08, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x03, 0x0C, 0x30, 0x0C, 0x03, 0x7F,
        0x00, 0x00, 0x26, 0x49, 0x49, 0x49, 0x32, 0x00, 0x00, 0x7F, 0x02, 0x04, 0x08, 0x10, 0x7F, 0x00, /********************************/
};

int main()
{
    // LED_InitTypeDef led1;
    // Led1_Init(&led1);

    KEY4X4_InitTypeDef keyboard;
    KEY4X4_Init(
        &keyboard,
        RCC_APB2Periph_GPIOB,
        GPIOB,
        GPIO_Pin_12,
        GPIO_Pin_13,
        GPIO_Pin_14,
        GPIO_Pin_15,
        RCC_APB2Periph_GPIOA,
        GPIOA,
        GPIO_Pin_7,
        GPIO_Pin_6,
        GPIO_Pin_5,
        GPIO_Pin_4);

    OLED_InitTypeDef oled1;

    // Soft
    // I2C_Soft_InitTypeDef i2cSoft;
    // I2C_Soft_Init(&i2cSoft, RCC_APB2Periph_GPIOB, GPIOB, GPIO_Pin_6, GPIO_Pin_7);
    // OLED_Soft_Init(&oled1, &i2cSoft);

    // Device
    Oled1_Init(&oled1);

    // SERVO_TypeDef servo1;
    // SERVO_Init(&servo1, RCC_APB1Periph_TIM3, TIM3, 1, RCC_APB2Periph_GPIOA, GPIOA, GPIO_Pin_6);
    // SERVO_SetAngle(&servo1, servoAngle);

    PCA9685_InitTypeDef pca9685;
    PCA9685_Init(&pca9685, RCC_APB1Periph_I2C2, I2C2, RCC_APB2Periph_GPIOB, GPIOB, GPIO_Pin_10, GPIO_Pin_11);

    float servoAngle[10] = {0};

    while (1) {

        uint16_t keyValue = KEY4X4_GetKey(&keyboard);
        OLED_ShowBinNumber(&oled1, 0, 0, keyValue, 16, OLED_FONT_SIZE_12, OLED_COLOR_NORMAL);
        OLED_RefreshScreen(&oled1);
        // if (KEY_IsPressed(&key1) == 1) {
        //     LED_Toggle(&led1);

        //     if (LED_IsOn(&led1) == 1) {
        //         OLED_CleanBuffer(&oled1);
        //         // OLED_SetPixel(&oled1, 64, 20, OLED_COLOR_NORMAL);
        //         // OLED_DrawLine(&oled1, 0, 0, 127, 63, OLED_COLOR_NORMAL);
        //         // OLED_ShowChar(&oled1, 3, 48, 'A', 12, OLED_COLOR_NORMAL);
        //         // OLED_ShowChar(&oled1, 30, 48, 'A', 16, OlED_COLOR_REVERSED);

        //         // OLED_ShowString(&oled1, 3, 18, "Abendas", 12, OLED_COLOR_NORMAL);
        //         // OLED_ShowString(&oled1, 60, 38, "Abendas", 16, OlED_COLOR_REVERSED);

        //         // OLED_ShowNumber(&oled1, 70, 1, 1234567, 7, 12, OLED_COLOR_NORMAL);

        //         OLED_DrawImage(&oled1, 0, 0, 127, 63, OLED_BMP1);
        //         OLED_RefreshScreen(&oled1);
        //     } else {
        //         OLED_CleanBuffer(&oled1);
        //         OLED_RefreshScreen(&oled1);
        //     }

        //     servoAngle += 30;
        //     if (servoAngle > 180) {
        //         servoAngle = 0;
        //     }

        //     // SERVO_SetAngle(&servo1, servoAngle);
        //     PCA9685_SetAngle(&pca9685, ch, servoAngle);
        //     ch++;
        //     if (ch > 9) {
        //         ch = 0;
        //     }
        // }

        for (uint16_t i = 0; i < 10; i++) {
            if ((keyValue & (1 << i)) == (1 << i)) {
                servoAngle[i] += 30;
                if (servoAngle[i] > 180) {
                    servoAngle[i] = 0;
                }

                PCA9685_SetAngle(&pca9685, i, servoAngle[i]);
            }
        }

        if (((keyValue & (1 << 14)) == (1 << 14))) {
            for (uint16_t i = 0; i < 10; i++) {
                PCA9685_SetAngle(&pca9685, i, 0);
                servoAngle[i] = 0;
                Delay_ms(10);
            }
        } else if (((keyValue & (1 << 15)) == (1 << 15))) {
            for (uint16_t i = 0; i < 10; i++) {
                PCA9685_SetAngle(&pca9685, i, 180);
                Delay_ms(10);
                servoAngle[i] = 180;
            }
        }

        Delay_ms(300);
    }
}
